<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Technical specification for intergration with {geodk} • dkstat</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../katex-auto.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><link href="../deps/KaTex-0.16.10/katex.min.css" rel="stylesheet">
<script src="../deps/KaTex-0.16.10/katex.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Technical specification for intergration with {geodk}">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=B612+Mono:ital,wght@0,400;0,700;1,400;1,700&amp;family=Roboto+Mono:ital,wght@0,100..700;1,100..700&amp;display=swap" rel="stylesheet">
<!-- rogtemplate style sheet --><link href="../BS5/rogtemplate.min.css" rel="stylesheet">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-dark" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">dkstat</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9002</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/tech-specs-for-geodk.html">Technical specification for intergration with {geodk}</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/rOpenGov/dkstat/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Technical specification for intergration with {geodk}</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/rOpenGov/dkstat/blob/main/vignettes/tech-specs-for-geodk.Rmd" class="external-link"><code>vignettes/tech-specs-for-geodk.Rmd</code></a></small>
      <div class="d-none name"><code>tech-specs-for-geodk.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="what-is-this">What is this?<a class="anchor" aria-label="anchor" href="#what-is-this"></a>
</h2>
<p>This documents the technical specification for the integration
between <a href="https://ropengov.github.io/dkstat/">dkstat</a> and <a href="https://ropengov.github.io/geodk/" class="external-link">geodk</a>. It can be found
on this page and in <a href="https://ropengov.github.io/geodk/articles/tech-specs-for-dkstat.html" class="external-link">the
<code>{geodk}</code> documentation</a>.
vignette(“tech-specs-for-dkstat”, package = “geodk”).</p>
<div class="section level3">
<h3 id="why-would-you-want-to-read-this">Why would you want to read this?<a class="anchor" aria-label="anchor" href="#why-would-you-want-to-read-this"></a>
</h3>
<p>I honestly don’t know. This document is written mostly for me <a href="https://aleksanderbl.dk" class="external-link">(Aleksander)</a> and contributors to use
as a reference when maintaining this integration. If you have any
interest in the inner workings of how these two packages interact, then
please do read on.</p>
</div>
</div>
<div class="section level2">
<h2 id="integration-usage">Integration usage<a class="anchor" aria-label="anchor" href="#integration-usage"></a>
</h2>
<p>A thorough usage guide can be found in vignette(“geodk”, package =
“dkstat”), but below I will provide a technical walkthrough of the
integration.</p>
<div class="section level3">
<h3 id="main-goal">Main goal<a class="anchor" aria-label="anchor" href="#main-goal"></a>
</h3>
<p>The main goal of the integration between <a href="https://ropengov.github.io/dkstat/">dkstat</a> and
<a href="https://ropengov.github.io/geodk/" class="external-link">geodk</a> is to be able to run the following code and have
meaningful geographic information added to the statistics.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">dkstat</span><span class="fu">::</span><span class="fu"><a href="../reference/dst_get_all_data.html">dst_get_all_data</a></span><span class="op">(</span><span class="st">"laby04"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">geodk</span><span class="fu">::</span><span class="fu">geodk_enrich</span><span class="op">(</span><span class="op">)</span> <span class="co"># This function name is still debatable.</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="problem-description">Problem description<a class="anchor" aria-label="anchor" href="#problem-description"></a>
</h3>
<p>When accessing data from a table, e.g. “laby04” there is no obvious
way to know what column is geographic.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">dkstat</span><span class="fu">::</span><span class="fu"><a href="../reference/dst_get_all_data.html">dst_get_all_data</a></span><span class="op">(</span><span class="st">"laby01"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="va">KOMGRP</span>, .keep_all <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;                  KOMGRP           BEVÆGELSE        TID value</span></span>
<span><span class="co">#&gt; 100   846 Mariagerfjord B04 Fødselsoverskud 2007-01-01  -0.3</span></span>
<span><span class="co">#&gt; 101           773 Morsø B04 Fødselsoverskud 2007-01-01  -1.3</span></span>
<span><span class="co">#&gt; 102          840 Rebild B04 Fødselsoverskud 2007-01-01   1.7</span></span>
<span><span class="co">#&gt; 103         787 Thisted B04 Fødselsoverskud 2007-01-01  -1.6</span></span>
<span><span class="co">#&gt; 104 820 Vesthimmerlands B04 Fødselsoverskud 2007-01-01  -0.8</span></span>
<span><span class="co">#&gt; 105         851 Aalborg B04 Fødselsoverskud 2007-01-01   1.6</span></span></code></pre></div>
<p>When looking at the above tail, I (and probably you, as well) can
recognise that the <code>OMRÅDE</code> column is the geographic one.</p>
<div class="section level4">
<h4 id="tables-with-multiple-geographic-levels">Tables with multiple geographic levels<a class="anchor" aria-label="anchor" href="#tables-with-multiple-geographic-levels"></a>
</h4>
<p>Some tables, e.g. “laby04” has multiple geographic levels. This table
has a grouping of municipalities and then the individual municipalities.
To ensure that the individuals <em>and</em> groups are enriched
properly, we have to take the different levels into account in the
method.</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="s3-methods">S3 methods<a class="anchor" aria-label="anchor" href="#s3-methods"></a>
</h2>
<p>Below you can find the description of each S3-class that is used
(/abused) to enrich the statistical data with geographic information. It
is sectioned by the geographic grouping of the dataset. Before we dive
into the specific classes, I will first outline the general idea. For
more information on the specific terminology used, please consult <span class="citation">Wickham (2019)</span>.</p>
<div class="section level3">
<h3 id="classes">Classes<a class="anchor" aria-label="anchor" href="#classes"></a>
</h3>
<p>Each type of geographic variable has its own S3 class. The class is
determined by what observations is included in the variable. The
class-assignment is done by a series of custom class-constructors called
<code>new_dkstat_*()</code>. One example is
<code>new_dkstat_Denmark_municipality_07()</code> which assigns the S3
class <code>dkstat_Denmark_municipality_07</code> to a dataset. The
class is assigned “after the fact”, as Wickham calls it, ensuring that
the usual behaviour of a data.frame is preserved, through inheritance
for all the functions that don’t know about these special classes
(e.g. the <a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a> functions). Thus, the dkstat-classes are
subclasses of <code>data.frame</code>. The class names are derived from
the API and maps 1:1 to the <code>map</code> value that is returned for
geographic variables.</p>
</div>
<div class="section level3">
<h3 id="method-dispatch">Method dispatch<a class="anchor" aria-label="anchor" href="#method-dispatch"></a>
</h3>
<p>The S3 generic can be found in <code>geodk::geodk_enrich()</code>.
The individual methods also live in <a href="https://ropengov.github.io/geodk/" class="external-link">geodk</a>. This is to not
take on <a href="https://ropengov.github.io/geodk/" class="external-link">geodk</a> as a dependency in <a href="https://ropengov.github.io/dkstat/">dkstat</a>.
The S3 method for the municipality group (Denmark_municipality_07) from
above is called
<code>geodk_enrich.dkstat_Denmark_municipality_07()</code>. Please <a href="https://github.com/rOpenGov/geodk/issues" class="external-link">open an issue</a> if you
would like to help add a method from another data source.</p>
</div>
</div>
<div class="section level2">
<h2 id="custom-classes">Custom classes<a class="anchor" aria-label="anchor" href="#custom-classes"></a>
</h2>
<p>The API provides 14 different map-levels from which I have based the
classes. This makes it very easy to add the right one. In
<a href="https://ropengov.github.io/dkstat/">dkstat</a> <code>data-raw/dst_map.R</code> you can find a
script that checks all tables for <em>map</em> variables and adds each
new one to a list. This gives the below vector.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#&gt; [1] "Denmark_municipality_07"             "Verden_dk2"                         </span></span>
<span><span class="co">#&gt; [3] "denmark_cities_19"                   "denmark_parish_23_4c"               </span></span>
<span><span class="co">#&gt; [5] "denmark_municipalitygroups_24"       "Denmark_region_07"                  </span></span>
<span><span class="co">#&gt; [7] "Denmark_rural_07"                    "denmark_multimember_constituency_23"</span></span>
<span><span class="co">#&gt; [9] "denmark_deanary_23"                  "europe_dk"                          </span></span>
<span><span class="co">#&gt; [11] "Verden_dk"                           "Europa_DK3"                         </span></span>
<span><span class="co">#&gt; [13] "Denmark_county"                      "Verden_dk4"          </span></span></code></pre></div>
<p>Some of the geographic levels, such as “Verden_dk” includes other
countries. This data is not available from <a href="https://ropengov.github.io/geodk/" class="external-link">geodk</a> thus
leading to a message for the user informing them of this and then asking
if it should add geometry for Denmark.</p>
<div class="section level3">
<h3 id="denmark_municipality_07---municipalities-and-groups">Denmark_municipality_07 - Municipalities and groups<a class="anchor" aria-label="anchor" href="#denmark_municipality_07---municipalities-and-groups"></a>
</h3>
<p>The municipality grouping that are specified by Statistics Denmark
are described <a href="https://www.dst.dk/da/Statistik/dokumentation/nomenklaturer/kommunegrupper" class="external-link">on
this website</a>. This grouping includes both the individual
municipality and five groupings. Take a look at the link if you would
like to learn more. In the <a href="https://ropengov.github.io/geodk/" class="external-link">geodk</a> backend I have created a
list containing all the municipality names with both Statistics
Denmark-naming and geodk-naming. In addition to that, the list is
ordered by the municipality grouping.</p>
<p>This grouping is assigned the
<code>dkstat_Denmark_municipality_07</code> class in addition to the
<code>data.frame</code> class it already has.</p>
<p>The method for <code>dkstat_Denmark_municipality_07</code> first
filters the groupings from the individual municipalities. A list of the
individual municipalities and groupings, along with their specific ids
is stored in <a href="https://ropengov.github.io/geodk/" class="external-link">geodk</a>. It is not exported to the user.</p>
<p>After filtering, it assigns the individual municipality geometries.
The grouping geometries are also assigned as well as a column indicating
the geographic nature of the observation - Is it a overall grouping or
an individual municipality?</p>
<p>The municipalities that make up the groupings are split per group and
run through <code><a href="https://r-spatial.github.io/sf/reference/geos_combine.html" class="external-link">sf::st_union()</a></code> to be returned as a
<code>sf</code> geometry per group.</p>
</div>
<div class="section level3">
<h3 id="verden_dk2">Verden_dk2<a class="anchor" aria-label="anchor" href="#verden_dk2"></a>
</h3>
</div>
<div class="section level3">
<h3 id="denmark_cities_19">denmark_cities_19<a class="anchor" aria-label="anchor" href="#denmark_cities_19"></a>
</h3>
</div>
<div class="section level3">
<h3 id="denmark_parish_23_4c">denmark_parish_23_4c<a class="anchor" aria-label="anchor" href="#denmark_parish_23_4c"></a>
</h3>
</div>
<div class="section level3">
<h3 id="denmark_municipalitygroups_24">denmark_municipalitygroups_24<a class="anchor" aria-label="anchor" href="#denmark_municipalitygroups_24"></a>
</h3>
</div>
<div class="section level3">
<h3 id="denmark_region_07">Denmark_region_07<a class="anchor" aria-label="anchor" href="#denmark_region_07"></a>
</h3>
</div>
<div class="section level3">
<h3 id="denmark_rural_07">Denmark_rural_07<a class="anchor" aria-label="anchor" href="#denmark_rural_07"></a>
</h3>
</div>
<div class="section level3">
<h3 id="denmark_multimember_constituency_23">denmark_multimember_constituency_23<a class="anchor" aria-label="anchor" href="#denmark_multimember_constituency_23"></a>
</h3>
</div>
<div class="section level3">
<h3 id="denmark_deanary_23">denmark_deanary_23<a class="anchor" aria-label="anchor" href="#denmark_deanary_23"></a>
</h3>
</div>
<div class="section level3">
<h3 id="europe_dk">europe_dk<a class="anchor" aria-label="anchor" href="#europe_dk"></a>
</h3>
</div>
<div class="section level3">
<h3 id="verden_dk">Verden_dk<a class="anchor" aria-label="anchor" href="#verden_dk"></a>
</h3>
</div>
<div class="section level3">
<h3 id="europa_dk3">Europa_DK3<a class="anchor" aria-label="anchor" href="#europa_dk3"></a>
</h3>
</div>
<div class="section level3">
<h3 id="denmark_county">Denmark_county<a class="anchor" aria-label="anchor" href="#denmark_county"></a>
</h3>
</div>
<div class="section level3">
<h3 id="verden_dk4">Verden_dk4<a class="anchor" aria-label="anchor" href="#verden_dk4"></a>
</h3>
</div>
</div>
<div class="section level2">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-adv-r" class="csl-entry">
Wickham, Hadley. 2019. <em>Advanced r, Second Edition</em>. 2nd ed.
Chapman &amp; Hall/CRC the r Series. Boca Raton, FL: CRC Press.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://aleksanderbl.dk" class="external-link">Aleksander Bang-Larsen</a>, Kenneth Rose.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>



    <!-- Add ropengov logo -->
  <script src="../BS5/logo.js"></script>
</body>
</html>
